<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chat System</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 20px;
        }
        .chat-container {
            max-width: 800px;
            margin: 0 auto;
            border: 1px solid #ccc;
            border-radius: 5px;
        }
        .chat-messages {
            height: 400px;
            overflow-y: auto;
            padding: 20px;
            background: #f9f9f9;
        }
        .message {
            margin-bottom: 10px;
            padding: 10px;
            border-radius: 5px;
        }
        .message.user {
            background: #e3f2fd;
            margin-left: 20%;
        }
        .message.admin {
            background: #f5f5f5;
            margin-right: 20%;
        }
        .chat-input {
            display: flex;
            padding: 20px;
            border-top: 1px solid #ccc;
        }
        input[type="text"] {
            flex: 1;
            padding: 10px;
            margin-right: 10px;
        }
        button {
            padding: 10px 20px;
            background: #2196f3;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
        }
        .file-input {
            margin-right: 10px;
        }
    </style>
</head>
<body>
    <div class="chat-container">
        <div class="chat-messages" id="messages"></div>
        <div class="chat-input">
            <input type="file" id="fileInput" class="file-input">
            <input type="text" id="messageInput" placeholder="Type a message...">
            <button onclick="sendMessage()">Send</button>
        </div>
    </div>

    <script>
        const urlParams = new URLSearchParams(window.location.search);
        const orderId = '679cfaac4e067193193e38c0';  // Hardcoded order ID
        const userToken = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpZCI6IjY3OWNlNWE3YmFkZTk1ZDBkODQwZmM1ZSIsInJvbGUiOiJ1c2VyIiwiZW1haWwiOiJ0ZXN0QGV4YW1wbGUuY29tIiwiaWF0IjoxNzM4MzM1NzEzLCJleHAiOjE3Mzg0MjIxMTN9.lJk8pxznLH37Rbb-Va_qdm2Jk9VG-YlhVsmrRhR2p0Q';
        const adminToken = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpZCI6IjY3OTlmNzNmODUyMWZlMDdmMTE3NTNkYiIsInJvbGUiOiJhcHBfYWRtaW4iLCJlbXBsb3llZUlkIjoiQURNSU4wMDIiLCJpYXQiOjE3MzgyNTM3OTAsImV4cCI6MTczODM0MDE5MH0.afCXACsZZhjhTc8pzsaJVAXQ_B2Fw5VZf0RpnbdAqOE';

        // Get token based on userType from URL
        const userType = urlParams.get('userType') || 'user';
        const token = userType === 'admin' ? adminToken : userToken;

        // Update WebSocket connection with error handling
        let ws;
        let reconnectAttempts = 0;
        const maxReconnectAttempts = 5;

        function connectWebSocket() {
            ws = new WebSocket(`ws://${window.location.host}/chat?orderId=${orderId}&token=${token}&userType=${userType}`);

            ws.onopen = () => {
                console.log('Connected to WebSocket');
                reconnectAttempts = 0;
                loadChatHistory();
            };

            ws.onclose = (event) => {
                console.log('WebSocket closed:', event);
                if (reconnectAttempts < maxReconnectAttempts) {
                    console.log(`Attempting to reconnect (${reconnectAttempts + 1}/${maxReconnectAttempts})...`);
                    reconnectAttempts++;
                    setTimeout(connectWebSocket, 5000);
                } else {
                    console.log('Max reconnection attempts reached');
                    alert('Connection lost. Please refresh the page.');
                }
            };

            ws.onerror = (error) => {
                console.error('WebSocket error:', error);
            };

            ws.onmessage = (event) => {
                const data = JSON.parse(event.data);
                console.log('Received message:', data);
                if (data.type === 'message') {
                    displayMessage(data.data);
                } else if (data.type === 'error') {
                    console.error('Server error:', data.message);
                    alert(data.message);
                }
            };
        }

        // Initial connection
        connectWebSocket();

        // Update send message function
        function sendMessage() {
            if (!ws || ws.readyState !== WebSocket.OPEN) {
                console.error('WebSocket is not connected');
                alert('Connection lost. Please wait for reconnection or refresh the page.');
                return;
            }

            const messageInput = document.getElementById('messageInput');
            const fileInput = document.getElementById('fileInput');
            const file = fileInput.files[0];
            const sendButton = document.querySelector('button');

            if (!messageInput.value && !file) return;

            try {
                // Disable send button while processing
                sendButton.disabled = true;
                sendButton.textContent = 'Sending...';

                if (file) {
                    // Validate file size
                    if (file.size > 5 * 1024 * 1024) {
                        alert('File size exceeds 5MB limit');
                        return;
                    }

                    // Compress image if it's an image file
                    if (file.type.startsWith('image/')) {
                        const img = new Image();
                        img.src = URL.createObjectURL(file);
                        img.onload = function() {
                            const canvas = document.createElement('canvas');
                            const ctx = canvas.getContext('2d');
                            
                            // Calculate new dimensions (max 1024px)
                            let width = img.width;
                            let height = img.height;
                            const maxSize = 1024;
                            
                            if (width > height && width > maxSize) {
                                height *= maxSize / width;
                                width = maxSize;
                            } else if (height > maxSize) {
                                width *= maxSize / height;
                                height = maxSize;
                            }

                            canvas.width = width;
                            canvas.height = height;
                            ctx.drawImage(img, 0, 0, width, height);

                            // Convert to blob with reduced quality
                            canvas.toBlob((blob) => {
                                const reader = new FileReader();
                                reader.onload = (e) => {
                                    const message = {
                                        type: 'image',
                                        content: messageInput.value || file.name,
                                        file: {
                                            name: file.name,
                                            type: file.type,
                                            size: blob.size,
                                            data: e.target.result
                                        }
                                    };
                                    ws.send(JSON.stringify(message));
                                    
                                    // Reset UI
                                    messageInput.value = '';
                                    fileInput.value = '';
                                    sendButton.disabled = false;
                                    sendButton.textContent = 'Send';
                                };
                                reader.readAsDataURL(blob);
                            }, 'image/jpeg', 0.7); // Reduce quality to 70%
                        };
                    } else {
                        // Handle non-image files
                        const reader = new FileReader();
                        reader.onload = (e) => {
                            const message = {
                                type: 'file',
                                content: messageInput.value || file.name,
                                file: {
                                    name: file.name,
                                    type: file.type,
                                    size: file.size,
                                    data: e.target.result
                                }
                            };
                            ws.send(JSON.stringify(message));
                            
                            // Reset UI
                            messageInput.value = '';
                            fileInput.value = '';
                            sendButton.disabled = false;
                            sendButton.textContent = 'Send';
                        };
                        reader.readAsDataURL(file);
                    }
                } else {
                    // Handle text messages
                    const message = {
                        type: 'text',
                        content: messageInput.value
                    };
                    ws.send(JSON.stringify(message));
                    
                    // Reset UI
                    messageInput.value = '';
                    fileInput.value = '';
                    sendButton.disabled = false;
                    sendButton.textContent = 'Send';
                }
            } catch (error) {
                console.error('Error sending message:', error);
                alert('Error sending message. Please try again.');
                sendButton.disabled = false;
                sendButton.textContent = 'Send';
            }
        }

        function displayMessage(message) {
            const messagesDiv = document.getElementById('messages');
            const messageElement = document.createElement('div');
            messageElement.className = `message ${message.senderType}`;

            let content = '';
            if (message.messageType === 'text') {
                content = message.content;
            } else if (message.messageType === 'image') {
                content = `
                    <img src="${message.fileUrl}" style="max-width: 200px;" 
                         onerror="this.onerror=null; this.src='data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 24 24%22><text x=%2212%22 y=%2212%22>❌</text></svg>';"
                         onload="this.style.display='inline';" 
                         style="display: none;"><br>
                    ${message.content}
                `;
            } else if (message.messageType === 'file') {
                content = `<a href="${message.fileUrl}" target="_blank">${message.fileName}</a><br>${message.content}`;
            }

            messageElement.innerHTML = `
                <strong>${message.senderType}</strong><br>
                ${content}
                <br>
                <small>${new Date(message.createdAt).toLocaleString()}</small>
            `;

            messagesDiv.appendChild(messageElement);
            messagesDiv.scrollTop = messagesDiv.scrollHeight;
        }

        async function loadChatHistory() {
            try {
                const response = await fetch(`/api/v1/chat/history/${orderId}`, {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });
                const data = await response.json();
                if (data.success) {
                    data.data.forEach(message => displayMessage(message));
                }
            } catch (error) {
                console.error('Error loading chat history:', error);
            }
        }
    </script>
</body>
</html>